<project name="apple-installer" basedir="../../">
    <property file="ant/project.properties"/>
    <import file="${basedir}/ant/version.xml"/>

    <!--
    ################################################################
    #                     Apple Installer                          #
    ################################################################
    -->
    <!-- Inform javafx.xml  -->
    <target name="pkgbuild-preflight">
        <property name="target.platform.mac" value="true"/>
    </target>

    <!-- Inform javafx.xml  -->
    <target name="dmg-preflight">
        <property name="target.platform.mac" value="true"/>
    </target>

    <target name="build-app" depends="codesign-jre,get-version">
        <echo level="info">Creating app bundle</echo>
        <property file="ant/apple/apple.properties"/>
        <!--
        ###################################
        #   Build MacOS Bundle Structure  #
        ###################################
        -->

        <property name="build.appdir" value="${dist.dir}/${project.name}.app"/>

        <!-- App Bundle -->
        <mkdir dir="${build.appdir}"/>

        <!-- Contents/ -->
        <copy file="ant/apple/apple-bundle.plist.in" tofile="${build.appdir}/Contents/Info.plist">
            <filterchain><expandproperties/></filterchain>
        </copy>

        <!-- Contents/MacOS/ -->
        <mkdir dir="${build.appdir}/Contents/MacOS"/>
        <copy file="ant/unix/unix-launcher.sh.in" tofile="${build.appdir}/Contents/MacOS/${project.name}">
            <filterchain><expandproperties/></filterchain>
        </copy>

        <!-- Contents/Resources/ -->
        <copy todir="${build.appdir}/Contents/Resources">
            <fileset dir="${dist.dir}">
                <include name="qz-tray.jar"/>
                <include name="LICENSE.txt"/>
            </fileset>
        </copy>
        <copy file="assets/branding/apple-icon.icns" tofile="${build.appdir}/Contents/Resources/${project.filename}.icns"/>

        <copy file="ant/unix/unix-uninstall.sh.in" tofile="${build.appdir}/Contents/Resources/uninstall">
            <filterchain><expandproperties/></filterchain>
        </copy>

        <copy todir="${build.appdir}/Contents/Resources/demo">
            <fileset dir="${dist.dir}/demo" includes="**"/>
        </copy>

        <!-- Java runtime -->
        <copy todir="${build.appdir}/Contents/PlugIns/Java.runtime">
            <fileset dir="${dist.dir}/Java.runtime" includes="**"/>
        </copy>
        <copy todir="${build.appdir}/Contents/Frameworks">
            <fileset dir="${dist.dir}/libs" includes="**"/>
        </copy>

        <!-- set bundle files executable -->
        <chmod perm="a+x" type="file">
            <fileset dir="${build.appdir}/Contents">
                <include name="**/${project.name}"/>
                <include name="**/Resources/uninstall"/>
                <include name="**/bin/*"/>
                <include name="**/lib/jspawnhelper"/>
            </fileset>
        </chmod>

    </target>

    <target name="build-pkg" depends="build-app,codesign-jre,get-version">
        <echo level="info">Creating installer using pkgbuild</echo>
        <property file="ant/apple/apple.properties"/>
        <!--
        #####################################
        #  Create scripts, payload and pkg  #
        #####################################
        -->

        <!-- scripts/ -->
        <copy file="ant/apple/apple-preinstall.sh.in" tofile="${build.dir}/scripts/preinstall">
            <filterchain><expandproperties/></filterchain>
        </copy>
        <copy file="ant/apple/apple-postinstall.sh.in" tofile="${build.dir}/scripts/postinstall">
            <filterchain><expandproperties/></filterchain>
        </copy>
        <chmod perm="a+x" type="file">
            <fileset dir="${build.dir}/scripts">
                <include name="preinstall"/>
                <include name="postinstall"/>
            </fileset>
        </chmod>

        <!-- Copy app bundle -->
        <mkdir dir="${build.dir}/scripts/payload"/>

        <property name="build.sandboxed" value="false"/>
        <antcall target="copy-bundle">
            <param name="build.copydir" value="${build.dir}/scripts/payload/${project.name}.app"/>
        </antcall>

        <!-- Disable signing and append "-community" if id is missing -->
        <exec executable="bash" failonerror="false" resultproperty="codesign.qz">
            <arg value="-c"/>
            <arg value="security find-identity -v |grep '(${apple.packager.signid})'"/>
        </exec>

        <!-- pkgbuild will fail on blank options; use ownership flag as a dummy fallback  -->
        <condition property="codesign.qz.cmd" value="--sign" else="--ownership">
            <equals arg1="${codesign.qz}" arg2="0"/>
        </condition>
        <condition property="codesign.qz.val" value="${apple.packager.signid}" else="recommended">
            <equals arg1="${codesign.qz}" arg2="0"/>
        </condition>
        <condition property="codesign.qz.suffix" value="" else="-community">
            <equals arg1="${codesign.qz}" arg2="0"/>
        </condition>

        <exec executable="pkgbuild" failonerror="true">
            <arg value="--identifier"/>
            <arg value="${project.filename}"/>

            <arg value="--nopayload"/>

            <arg value="--install-location"/>
            <arg value="/Applications/${project.name}.app"/>

            <arg value="--scripts"/>
            <arg value="${build.dir}/scripts"/>

            <arg value="--version"/>
            <arg value="${build.version}"/>

            <arg value="${codesign.qz.cmd}"/>
            <arg value="${codesign.qz.val}"/>

            <arg value="${out.dir}/${project.filename}${build.type}-${build.version}${codesign.qz.suffix}.pkg"/>
        </exec>
    </target>

    <target name="build-dmg" depends="build-app,codesign-jre,get-version">
        <echo level="info">Creating app bundle</echo>
        <property file="ant/apple/apple.properties"/>

        <!-- Dmg JSON -->
        <copy file="ant/apple/appdmg.json.in" tofile="${build.dir}/appdmg.json">
            <filterchain><expandproperties/></filterchain>
        </copy>

        <property name="build.sandboxed" value="true"/>
        <antcall target="copy-bundle">
            <param name="build.copydir" value="${dist.dir}/${project.name}.app"/>
        </antcall>

        <!-- Disable signing and append "-community" if id is missing -->
        <exec executable="bash" failonerror="false" resultproperty="codesign.qz">
            <arg value="-c"/>
            <arg value="security find-identity -v |grep '(${apple.packager.signid})'"/>
        </exec>

        <condition property="codesign.qz.suffix" value="" else="-community">
            <equals arg1="${codesign.qz}" arg2="0"/>
        </condition>

        <exec executable="appdmg" failonerror="true">
            <arg value="${build.dir}/appdmg.json"/>
            <arg value="${out.dir}/${project.filename}${build.type}-${build.version}${codesign.qz.suffix}.dmg"/>
        </exec>
    </target>

    <target name="codesign-jre" if="codesign.mac" unless="jre.skip">
        <property file="ant/apple/apple.properties"/>
    </target>

    <target name="copy-bundle">
        <copy todir="${build.copydir}">
            <fileset dir="${build.appdir}" includes="**"/>
        </copy>

        <!-- set payload files executable -->
        <chmod perm="a+x" type="file">
            <fileset dir="${build.copydir}">
                <include name="**/${project.name}"/>
                <include name="**/Resources/uninstall"/>
                <include name="**/bin/*"/>
                <include name="**/lib/jspawnhelper"/>
            </fileset>
        </chmod>

        <copy file="ant/apple/apple-entitlements.plist.in" tofile="${build.dir}/apple-entitlements.plist">
            <filterchain><expandproperties/></filterchain>
        </copy>
        <copy file="ant/apple/apple-entitlements-inherit.plist.in" tofile="${build.dir}/apple-entitlements-inherit.plist">
            <filterchain><expandproperties/></filterchain>
        </copy>

        <!-- use xargs to loop over and codesign all files-->
        <echo level="info" message="Signing ${build.copydir} using ${apple.packager.signid}"/>
        <!-- Find -X fails on spaces but doesn't failonerror, this may lead to overlooked errors. -->
        <!-- Currently the only file that may contains a space is the main executable which we omit from signing anyway. -->
        <exec executable="bash" failonerror="true" dir="${build.copydir}">
            <arg value="-c"/>
            <arg value="find -X &quot;.&quot; -type f -not -name &quot;libjli.dylib&quot; -not -name &quot;${project.name}&quot; -exec sh -c 'file -I &quot;{}&quot; |grep -m1 &quot;x-mach-binary&quot;|cut -f 1 -d \:' \; |xargs codesign --force -s &quot;${apple.packager.signid}&quot; --timestamp --options runtime"/>
        </exec>
        <exec executable="codesign" failonerror="true">
            <arg value="--force"/>
            <arg line="-s &quot;${apple.packager.signid}&quot;"/>
            <arg value="--timestamp"/>
            <arg line="--options runtime"/>
            <arg line="--entitlement ${build.dir}/apple-entitlements-inherit.plist"/>
            <arg value="${build.copydir}/Contents/PlugIns/Java.runtime"/>
        </exec>
        <exec executable="codesign" failonerror="true">
            <arg value="--force"/>
            <arg line="-s &quot;${apple.packager.signid}&quot;"/>
            <arg value="--timestamp"/>
            <arg line="--options runtime"/>
            <arg line="--entitlement ${build.dir}/apple-entitlements.plist"/>
            <arg value="${build.copydir}"/>
        </exec>
    </target>

    <target name="codesign-jars" if="codesign.mac">
        <property file="ant/apple/apple.properties"/>
        <exec executable="security">
            <arg value="add-certificates"/>
            <arg value="${basedir}/ant/apple/certs/apple-packager.cer"/>
            <arg value="${basedir}/ant/apple/certs/apple-intermediate.cer"/>
            <arg value="${basedir}/ant/apple/certs/apple-codesign.cer"/>
        </exec>
        <antcall target="codesign-libs">
            <param name="signing.jarname" value="communication/jna-*.jar"/>
            <param name="signing.excluded" value="communication/jna-platform-*.jar"/>
            <param name="signing.filetype" value="*.jnilib"/>
        </antcall>
        <antcall target="codesign-libs">
            <param name="signing.jarname" value="communication/jssc-*.jar"/>
            <param name="signing.filetype" value="*.dylib"/>
        </antcall>
        <antcall target="codesign-libs">
            <param name="signing.jarname" value="communication/hid4java-*.jar"/>
            <param name="signing.filetype" value="*.dylib"/>
        </antcall>
        <antcall target="codesign-libs">
            <param name="signing.jarname" value="communication/libusb4java-*-osx-x86.jar"/>
            <param name="signing.filetype" value="*.dylib"/>
        </antcall>
        <antcall target="codesign-libs">
            <param name="signing.jarname" value="communication/libusb4java-*-osx-x86_64.jar"/>
            <param name="signing.filetype" value="*.dylib"/>
        </antcall>
    </target>

    <target name="codesign-libs">
        <path id="found.jar">
            <first>
                <fileset dir="lib">
                    <include name="**/${signing.jarname}"/>
                    <exclude name="**/${signing.excluded}" if="signing.excluded"/>
                </fileset>
            </first>
        </path>
        <pathconvert property="found.jar.path" refid="found.jar"/>

        <unzip src="${found.jar.path}" dest="${out.dir}/jar-signing"/>
        <path id="found.files">
            <fileset dir="${out.dir}/jar-signing">
                <include name="**/${signing.filetype}"/>
            </fileset>
        </path>
        <pathconvert property="found.files.paths" refid="found.files" pathsep=" "/>

        <!-- No-op: makes IntelliJ happy with the undefined "signing.delete" -->
        <condition description="suppress property warning" property="signing.delete" value="${signing.delete}">
            <isset property="signing.delete"/>
        </condition>
        <delete verbose="true">
            <fileset dir="${out.dir}/jar-signing">
                <include name="**/${signing.delete}" if="signing.delete"/>
            </fileset>
        </delete>

        <!-- Use xargs to loop over and codesign all files-->
        <echo message="Signing ${found.jar.path} using ${apple.packager.signid}"/>
        <exec executable="bash" failonerror="true">
            <arg value="-c"/>
            <arg value="echo &quot;${found.files.paths}&quot; |tr ':' '\n' |xargs codesign -f -s &quot;${apple.packager.signid}&quot; -v"/>
        </exec>

        <pathconvert property="found.jar.rel">
            <path refid="found.jar"/>
            <globmapper from="${basedir}/*" to="*" handledirsep="true"/>
        </pathconvert>
        <zip destfile="${sign.lib.dir}/${found.jar.rel}" basedir="${out.dir}/jar-signing" excludes="dont*.*"/>

        <!-- Cleanup temp folder-->
        <delete dir="${out.dir}/jar-signing"/>
    </target>
</project>
